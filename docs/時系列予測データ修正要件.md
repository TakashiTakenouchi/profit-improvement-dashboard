# 時系列予測データ修正要件

## 1. 概要

### 1.1 対象ファイル
| ファイル | 役割 | ステータス |
|---------|------|----------|
| `fixed_extended_store_data_2024-FIX_kaizen_monthlyvol6_new.xlsx` | **正データ（マスター）** | 修正不要 |
| `time_series_forecast_data_2024.xlsx` | **修正対象** | 要修正 |

### 1.2 問題の概要
時系列予測データ（`time_series_forecast_data_2024.xlsx`）の日付が**1年ズレている**ため、正データとの整合性が取れていない。

- **正データの日付範囲**: 2020/04/30 ～ 2025/12/31（69ヶ月）
- **時系列データの日付範囲**: 2019/04/01 ～ 2024/12/31（69ヶ月）

### 1.3 具体例
恵比寿店 `Mens_JACKETS&OUTER2` の2025年12月実績：
- **正データ**: 5,359,377.53円
- **時系列データ（2024-12）**: 3,003,223.12円（OriginalSales）

→ 日付が1年ズレているだけでなく、**金額自体も不一致**

---

## 2. データ構造分析

### 2.1 正データ（fixed_extended_store_data）
| 項目 | 値 |
|-----|---|
| シート | Sheet1 |
| 行数 | 138（恵比寿69行 + 横浜元町69行） |
| 日付範囲 | 2020/04/30 ～ 2025/12/31 |
| カテゴリー列 | O列～V列（8カテゴリー） |

**カテゴリー一覧**:
1. Mens_JACKETS&OUTER2（O列）
2. Mens_KNIT（P列）
3. Mens_PANTS（Q列）
4. WOMEN'S_JACKETS2（R列）
5. WOMEN'S_TOPS（S列）
6. WOMEN'S_ONEPIECE（T列）
7. WOMEN'S_bottoms（U列）
8. WOMEN'S_SCARF & STOLES（V列）

### 2.2 時系列データ（time_series_forecast_data）
| シート名 | 内容 | 行数 |
|---------|------|-----|
| DailyForecastData | 日次予測データ | 100,896行 |
| MonthlySummary | 月次集計 | 1,104行 |
| ItemSummary | 商品別集計 | 24行 |
| DistributionAnalysis | 分布分析 | 3行 |
| OriginalMonthlyData | 元月次データ | 138行 |
| ProductMaster | 商品マスタ | 48行 |
| ValidationResults | 検証結果 | 1,104行 |

**DailyForecastDataの構造**:
- 1日あたり24行（8カテゴリー × 3商品）
- 各カテゴリーに3つのItemCode（例: `Mens_JACKETS&OUTER2_001`, `_002`, `_003`）
- 主要カラム: Date, UnitPrice, ForecastQuantity, ForecastSales

---

## 3. 不整合箇所の特定

### 3.1 日付のズレ
| シート | 現在の日付範囲 | 修正後の日付範囲 |
|-------|--------------|----------------|
| DailyForecastData | 2019/04/01 ～ 2024/12/31 | **2020/04/30 ～ 2025/12/31** |
| MonthlySummary | 2019-04 ～ 2024-12 | **2020-04 ～ 2025-12** |
| OriginalMonthlyData | 2019-04 ～ 2024-12 | **2020-04 ～ 2025-12** |
| ValidationResults | 2019-04 ～ 2024-12 | **2020-04 ～ 2025-12** |

### 3.2 売上金額の不整合
恵比寿店の月次売上比較（正データ vs 時系列データ）:

| 正データ年月 | 正データ売上 | 時系列年月 | 時系列OriginalSales | 差異率 |
|------------|-------------|----------|-------------------|-------|
| 2024-10 | 1,834,843円 | 2023-10 | 1,834,843円 | 0% |
| 2024-11 | 2,435,043円 | 2023-11 | 2,435,043円 | 0% |
| 2024-12 | 3,733,026円 | 2023-12 | 3,733,026円 | 0% |
| **2025-01** | **5,090,611円** | 2024-01 | 618,843円 | **87.8%** |
| **2025-12** | **5,359,378円** | 2024-12 | 3,003,223円 | **44.0%** |

→ **2025年以降のデータが大幅に不一致**

### 3.3 ForecastSalesの計算式
```
ForecastSales ≠ UnitPrice × ForecastQuantity
```
現在、ForecastSalesは独自の計算ロジックで算出されており、単純な掛け算ではない。

---

## 4. 修正方針

### 4.1 基本原則
> **正データ（fixed_extended_store_data）が絶対正義**

時系列データを正データに合わせて修正する。

### 4.2 修正の優先順位
1. **日付の修正**（全シート）: +1年シフト
2. **OriginalMonthlyDataの修正**: 正データの値で上書き
3. **DailyForecastDataの修正**: ForecastQuantityを調整
4. **集計シートの再計算**: MonthlySummary, ValidationResults

---

## 5. 修正手順詳細

### Step 1: 日付の修正（全シート）

#### 1.1 DailyForecastDataシート
```python
# Date列を+1年シフト
df['Date'] = df['Date'] + pd.DateOffset(years=1)

# 開始日を2020/04/30に調整
# 2020/04/01～2020/04/29のデータを削除
# 最終日を2025/12/31に調整
```

#### 1.2 MonthlySummary, OriginalMonthlyData, ValidationResultsシート
```python
# YearMonth列を+1年シフト
# "2019-04" → "2020-04"
# "2024-12" → "2025-12"
```

### Step 2: OriginalMonthlyDataの修正

正データから各カテゴリーの月次売上を取得し、OriginalMonthlyDataを上書きする。

```python
# カテゴリーマッピング
category_mapping = {
    'Mens_JACKETS&OUTER2': 'Mens_JACKETS&OUTER2',
    'Mens_KNIT': 'Mens_KNIT',
    'Mens_PANTS': 'Mens_PANTS',
    "WOMEN'S_JACKETS2": "WOMEN'S_JACKETS2",
    "WOMEN'S_TOPS": "WOMEN'S_TOPS",
    "WOMEN'S_ONEPIECE": "WOMEN'S_ONEPIECE",
    "WOMEN'S_bottoms": "WOMEN'S_bottoms",
    "WOMEN'S_SCARF & STOLES": "WOMEN'S_SCARF & STOLES"
}
```

### Step 3: DailyForecastDataのForecastQuantity修正

**修正ロジック**:
1. 正データから月次売上を取得
2. 月内の日別売上配分比率を維持したまま、合計が正データと一致するようにForecastQuantityを調整
3. 調整式:
```python
調整係数 = 正データ月次売上 / (Σ UnitPrice × ForecastQuantity)
新ForecastQuantity = 元ForecastQuantity × 調整係数
```

### Step 4: 集計シートの再計算

#### 4.1 MonthlySummaryシート
```python
# DailyForecastDataから再集計
monthly_summary = df_daily.groupby(['YearMonth', 'Shop', 'Category']).agg({
    'ForecastSales': 'sum',
    'ForecastQuantity': 'sum',
    'ForecastGrossProfit': 'sum'
}).reset_index()
```

#### 4.2 ValidationResultsシート
```python
# OriginalSales: 正データから取得
# ForecastSalesSum: DailyForecastDataから集計
# Discrepancy: ForecastSalesSum - OriginalSales
# DiscrepancyRate: (Discrepancy / OriginalSales) * 100
```

---

## 6. 修正対象一覧

| シート | 修正項目 | 修正内容 |
|-------|---------|---------|
| DailyForecastData | Date | +1年シフト、範囲調整 |
| DailyForecastData | YearMonth | +1年シフト |
| DailyForecastData | ForecastQuantity | 調整係数で再計算 |
| DailyForecastData | ForecastSales | UnitPrice × 新ForecastQuantity |
| MonthlySummary | YearMonth | +1年シフト |
| MonthlySummary | ForecastSales等 | 再集計 |
| OriginalMonthlyData | YearMonth | +1年シフト |
| OriginalMonthlyData | カテゴリー売上 | 正データで上書き |
| ValidationResults | YearMonth | +1年シフト |
| ValidationResults | OriginalSales | 正データで上書き |
| ValidationResults | ForecastSalesSum等 | 再計算 |

---

## 7. 検証方法

修正完了後、以下の整合性チェックを実施:

### 7.1 日付整合性
- [ ] DailyForecastDataの日付範囲が2020/04/30～2025/12/31であること
- [ ] 全シートのYearMonthが2020-04～2025-12であること

### 7.2 売上整合性
- [ ] 各月の OriginalSales = 正データのカテゴリー売上
- [ ] 各月の ForecastSalesSum ≒ OriginalSales（許容誤差1%以内）
- [ ] Σ(UnitPrice × ForecastQuantity) = ForecastSalesSum

### 7.3 サンプル検証
恵比寿店 `Mens_JACKETS&OUTER2` 2025年12月:
- [ ] OriginalSales = 5,359,377.53円
- [ ] ForecastSalesSum ≒ 5,359,377.53円

---

## 8. 出力ファイル

修正後のファイル名: `time_series_forecast_data_2024_fixed.xlsx`

---

## 9. 次のステップ

修正完了後:
1. **AutoGluon TimeSeries** を使用した時系列予測の実施
2. 予測対象: 恵比寿店の8カテゴリー商品売上
3. 予測期間: 設定に応じて（例: 3ヶ月先、6ヶ月先）

---

## 10. 承認依頼

上記の修正要件に基づいて実装を開始してよろしいでしょうか？

- [ ] 承認する
- [ ] 修正・追加の要望あり
